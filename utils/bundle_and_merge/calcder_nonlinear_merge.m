function dzdz = calcder_nonlinear_merge(sol);

m = size(sol.tv,2);
n = size(sol.qtot,2);
p1 = 7; p1ut = 16;
p2 = 3; p2ut = 3;
dzdz = zeros(p1ut*m+p2ut*n,p1*m+p2*n);

% B{1} = [0 1 0 0;-1 0 0 0;0 0 0 0;0 0 0 0];
% B{2} = [0 0 -1 0;0 0 0 0;1 0 0 0;0 0 0 0];
% B{3} = [0 0 0 0;0 0 1 0;0 -1 0 0;0 0 0 0];
% B{4} = [0 0 0 1;0 0 0 0;0 0 0 0;0 0 0 0];
% B{5} = [0 0 0 0;0 0 0 1;0 0 0 0;0 0 0 0];
% B{6} = [0 0 0 0;0 0 0 0;0 0 0 1;0 0 0 0];
% BM = zeros(16,6);
% for ii = 1:6;
%     BM(:,ii)=B{ii}(:);
% end
% K{1} = [1 0 0;0 0 0;0 0 0];
% K{2} = [0 1 0;0 0 0;0 0 0];
% K{3} = [0 0 1;0 0 0;0 0 0];
% K{4} = [0 0 0;0 1 0;0 0 0];
% K{5} = [0 0 0;0 0 1;0 0 0];
% KM = zeros(9,5);
% for ii = 1:5;
%     KM(:,ii)=K{ii}(:);
% end
% KM = [ ...
% 1 , 0 , 0 , 0 , 0 ; ...
% 0 , 0 , 0 , 0 , 0 ; ...
% 0 , 0 , 0 , 0 , 0 ; ...
% 0 , 1 , 0 , 0 , 0 ; ...
% 0 , 0 , 0 , 1 , 0 ; ...
% 0 , 0 , 0 , 0 , 0 ; ...
% 0 , 0 , 1 , 0 , 0 ; ...
% 0 , 0 , 0 , 0 , 1 ; ...
% 0 , 0 , 0 , 0 , 0 ];
BM1 = [ ...
1, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, -1 , 0 , 0 , 0 , 0 , 0 ; ...
0, 0 , 1 , 0 , 0 , 0 , 0 ; ...
0, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, 1 , 0 , 0 , 0 , 0 , 0 ; ...
1, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, 0 , 0 , -1 , 0 , 0 , 0 ; ...
0, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, 0 , -1 , 0 , 0 , 0 , 0 ; ...
0, 0 , 0 , 1 , 0 , 0 , 0 ; ...
1, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, 0 , 0 , 0 , 1 , 0 , 0 ; ...
0, 0 , 0 , 0 , 0 , 1 , 0 ; ...
0, 0 , 0 , 0 , 0 , 0 , 1 ; ...
0, 0 , 0 , 0 , 0 , 0 , 0 ];
%BM2 = BM1;
% dz = randn(6,1); %dz(4:6)=zeros(3,1);
% T = eye(4);
% Tny = expm(reshape(BM*dz,4,4))*T

solut = sol;

% for i = 1:m;
%      Pold = reshape(solut.pv(:,i),3,4);   
%      [r,q]=rq(Pold)    
% end

dzdz = zeros(12*m+3*n,6*m+3*n);

for i = 1:m;
    iut = ( (i-1)*p1ut + (1:p1ut) );
    joffset = ( (i-1)*p1 );
    Pold = reshape(solut.tv(:,i),4,4);
%     for j = 1:5;
%         dpdz = reshape(KM(:,j),3,3)*q;
%         dzdz(iut,joffset+j) = dpdz(:);
%     end
    for j = 1:size(BM1,2);
        dpdz = Pold*reshape(BM1(:,j),4,4);
        dzdz(iut,joffset+j) = dpdz(:);
    end
end

dzdz((16*m+1):(16*m+3*n),(7*m+1):(7*m+3*n)) = eye(3*n);

dzdz = sparse(dzdz);
