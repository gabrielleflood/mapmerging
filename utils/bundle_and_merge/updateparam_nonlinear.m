function solut = updateparam_nonlinear(solin,dz);

m = size(solin.pv,2);
n = size(solin.U,2);
p1 = 6;
p2 = 3;

dz1 = dz(1:(6*m));
dz2 = dz((6*m) + (1:(3*n)));

% B{1} = [0 1 0 0;-1 0 0 0;0 0 0 0;0 0 0 0];
% B{2} = [0 0 -1 0;0 0 0 0;1 0 0 0;0 0 0 0];
% B{3} = [0 0 0 0;0 0 1 0;0 -1 0 0;0 0 0 0];
% B{4} = [0 0 0 1;0 0 0 0;0 0 0 0;0 0 0 0];
% B{5} = [0 0 0 0;0 0 0 1;0 0 0 0;0 0 0 0];
% B{6} = [0 0 0 0;0 0 0 0;0 0 0 1;0 0 0 0];
% BM = zeros(16,6);
% for ii = 1:6;
%     BM(:,ii)=B{ii}(:);
% end
% K{1} = [1 0 0;0 0 0;0 0 0];
% K{2} = [0 1 0;0 0 0;0 0 0];
% K{3} = [0 0 1;0 0 0;0 0 0];
% K{4} = [0 0 0;0 1 0;0 0 0];
% K{5} = [0 0 0;0 0 1;0 0 0];
% KM = zeros(9,5);
% for ii = 1:5;
%     KM(:,ii)=K{ii}(:);
% end
KM = [ ...
1 , 0 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 0 ; ...
0 , 1 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 1 , 0 ; ...
0 , 0 , 0 , 0 , 0 ; ...
0 , 0 , 1 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 1 ; ...
0 , 0 , 0 , 0 , 0 ];
BM1 = [ ...
0 , 0 , 0 , 0 , 0 , 0 ; ...
-1 , 0 , 0 , 0 , 0 , 0 ; ...
0 , 1 , 0 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 0 , 0 ; ...
1 , 0 , 0 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 0 , 0 ; ...
0 , 0 , -1 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 0 , 0 ; ...
0 , -1 , 0 , 0 , 0 , 0 ; ...
0 , 0 , 1 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 1 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 1 , 0 ; ...
0 , 0 , 0 , 0 , 0 , 1 ; ...
0 , 0 , 0 , 0 , 0 , 0 ];
BM2 = BM1;
% dz = randn(6,1); %dz(4:6)=zeros(3,1);
% T = eye(4);
% Tny = expm(reshape(BM*dz,4,4))*T

solut = solin;

% for i = 1:m;
%      Pold = reshape(solut.pv(:,i),3,4);   
%      [r,q]=rq(Pold)    
% end


for i = 1:m;
    dzt = dz( (i-1)*p1 + (1:p1) );
    Pold = reshape(solut.pv(:,i),3,4);
    [r,q]=rq(Pold);
    %&Pny = (r + reshape(KM*dzt(1:5),3,3))*q*expm(reshape(BM1*dzt(1:end),4,4));
    Pny = (r)*q*expm(reshape(BM1*dzt(1:end),4,4));
    solut.pv(:,i)=Pny(:);
    solut.P{i}=Pny;
end
%keyboard;
U = solin.U;
for j = 1:n;
    dzu = dz( (m*p1) + (j-1)*p2 + (1:p2) );
    U(1:3,j)=U(1:3,j)+ dzu;
end
solut.U = U;

