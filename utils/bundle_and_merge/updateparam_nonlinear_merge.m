function solut = updateparam_nonlinear_merge(solin,dz);

m = size(solin.tv,2);
n = size(solin.qtot,2);
p1 = 7;
p2 = 3;

dz1 = dz(1:(7*m));
dz2 = dz((7*m) + (1:(3*n)));

% B{1} = [0 1 0 0;-1 0 0 0;0 0 0 0;0 0 0 0];
% B{2} = [0 0 -1 0;0 0 0 0;1 0 0 0;0 0 0 0];
% B{3} = [0 0 0 0;0 0 1 0;0 -1 0 0;0 0 0 0];
% B{4} = [0 0 0 1;0 0 0 0;0 0 0 0;0 0 0 0];
% B{5} = [0 0 0 0;0 0 0 1;0 0 0 0;0 0 0 0];
% B{6} = [0 0 0 0;0 0 0 0;0 0 0 1;0 0 0 0];
% BM = zeros(16,6);
% for ii = 1:6;
%     BM(:,ii)=B{ii}(:);
% end
% K{1} = [1 0 0;0 0 0;0 0 0];
% K{2} = [0 1 0;0 0 0;0 0 0];
% K{3} = [0 0 1;0 0 0;0 0 0];
% K{4} = [0 0 0;0 1 0;0 0 0];
% K{5} = [0 0 0;0 0 1;0 0 0];
% KM = zeros(9,5);
% for ii = 1:5;
%     KM(:,ii)=K{ii}(:);
% end
KM = [ ...
1 , 0 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 0 ; ...
0 , 1 , 0 , 0 , 0 ; ...
0 , 0 , 0 , 1 , 0 ; ...
0 , 0 , 0 , 0 , 0 ; ...
0 , 0 , 1 , 0 , 0 ; ...
0 , 0 , 0 , 0 , 1 ; ...
0 , 0 , 0 , 0 , 0 ];
BM1 = [ ...
1, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, -1 , 0 , 0 , 0 , 0 , 0 ; ...
0, 0 , 1 , 0 , 0 , 0 , 0 ; ...
0, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, 1 , 0 , 0 , 0 , 0 , 0 ; ...
1, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, 0 , 0 , -1 , 0 , 0 , 0 ; ...
0, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, 0 , -1 , 0 , 0 , 0 , 0 ; ...
0, 0 , 0 , 1 , 0 , 0 , 0 ; ...
1, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, 0 , 0 , 0 , 0 , 0 , 0 ; ...
0, 0 , 0 , 0 , 1 , 0 , 0 ; ...
0, 0 , 0 , 0 , 0 , 1 , 0 ; ...
0, 0 , 0 , 0 , 0 , 0 , 1 ; ...
0, 0 , 0 , 0 , 0 , 0 , 0 ];
BM2 = BM1;
% dz = randn(6,1); %dz(4:6)=zeros(3,1);
% T = eye(4);
% Tny = expm(reshape(BM*dz,4,4))*T

solut = solin;

% for i = 1:m;
%      Pold = reshape(solut.pv(:,i),3,4);   
%      [r,q]=rq(Pold)    
% end


for i = 1:m;
    dzt = dz( (i-1)*p1 + (1:p1) );
    Told = reshape(solut.tv(:,i),4,4);
    %&Pny = (r + reshape(KM*dzt(1:5),3,3))*q*expm(reshape(BM1*dzt(1:end),4,4));
    Tny = Told*expm(reshape(BM1*dzt(1:end),4,4));
    solut.tv(:,i)=Tny(:);
    solut.T{i}=Tny;
end
%keyboard;
qtot = solin.qtot;
for j = 1:n;
    dzu = dz( (m*p1) + (j-1)*p2 + (1:p2) );
    qtot(1:3,j)=qtot(1:3,j)+ dzu;
end
solut.qtot = qtot;

